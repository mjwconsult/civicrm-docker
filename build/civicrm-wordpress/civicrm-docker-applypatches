#!/bin/bash

set -e

CIVICRM_CORE_PATH="/var/www/html/wp-content/plugins/civicrm/civicrm"
CIVICRM_CORE_PATCHES_PATH="/var/www/patches"
CIVICRM_WP_PATH="/var/www/html/wp-content/plugins/civicrm"
CIVICRM_WP_PATCHES_PATH="/var/www/patches/wp"

FLAG_APPLIED="/var/www/html/wp-content/plugins/civicrm/mjw-applied"

PATCHLOG="${CIVICRM_CORE_PATCHES_PATH}/patchlog.log"

echo `date` > "${PATCHLOG}"
# If we didn't do a docker-compose down (eg. on a server restart)
#  then patches are already applied so do nothing
if [ -f "${FLAG_APPLIED}" ]; then
  echo 'Patches already applied' >> "${PATCHLOG}"
  exit 0;
fi

echo 'Patching CiviCRM WordPress' >> "${PATCHLOG}"
cd ${CIVICRM_WP_PATH} || exit 1
for patchfile in "${CIVICRM_WP_PATCHES_PATH}"/*.diff; do (echo "$patchfile"; patch -p1 < "$patchfile") | tee -a "${PATCHLOG}"; done

echo 'Patching CiviCRM Core' >> "${PATCHLOG}"
cd ${CIVICRM_CORE_PATH} || exit 1
for patchfile in "${CIVICRM_CORE_PATCHES_PATH}"/*.diff; do (echo "$patchfile"; patch -p1 < "$patchfile") | tee -a "${PATCHLOG}"; done

touch "${FLAG_APPLIED}"